<script lang="ts">
  import { onMount } from 'svelte'
  import { api } from '../services/api'
  import { auth } from '../stores/auth'
  import { renderMarkdown } from '../utils/markdown'
  import { createHref } from '../utils/navigation'
  import PostItem from '../components/PostItem.svelte'
  import PostForm from '../components/PostForm.svelte'
  import GroupViewGrid from '../components/GroupViewGrid.svelte'
  import GroupViewList from '../components/GroupViewList.svelte'
  import GroupViewCards from '../components/GroupViewCards.svelte'
  import type { Entity } from '../types'

  export let path: string = '/'

  // Use the path prop as the slug
  let slug: string = path
  
  $: {
    slug = path
  }

  let entity: Entity | null = null
  let children: Entity[] = []
  let loading = true
  let showNewPost = false
  let error: string | null = null

  onMount(async () => {
    if (slug) {
      await loadEntity()
    }
  })

  // Watch for slug changes
  $: if (slug) {
    loadEntity()
  }

  async function loadEntity() {
    loading = true
    error = null
    entity = null
    children = []
    
    try {
      // Ensure slug has leading slash
      const querySlug = slug.startsWith('/') ? slug : `/${slug}`
      
      console.log('EntityView: Loading entity with slug:', querySlug)
      const entityData = await api.getEntityBySlug(querySlug)
      console.log('EntityView: Received entity data:', entityData)
      
      if (!entityData) {
        throw new Error(`Entity not found: ${querySlug}`)
      }
      
      entity = entityData
      
      // Load children (posts, sub-groups, etc.)
      try {
        const childrenData = await api.queryEntities({ 
          parentId: entityData.id,
          limit: 100 
        })
        children = childrenData || []
      } catch (childErr) {
        console.error('Failed to load children:', childErr)
        // Don't fail the whole page if children can't be loaded
        children = []
      }
    } catch (err: any) {
      console.error('Failed to load entity:', err)
      if (err.status === 404 || err.message?.includes('not found') || err.message?.includes('Entity not found')) {
        // Special handling for root entity not found
        if (querySlug === '/') {
          error = null
          entity = null
          // Fall back to showing all top-level groups from cache
          try {
            const groups = await api.queryEntities({ 
              type: 'group',
              limit: 100 
            })
            children = groups || []
            if (children.length === 0) {
              // No groups found, but that's okay - maybe there's just no content yet
              console.log('No groups found, showing empty state')
            }
          } catch (groupErr) {
            console.error('Failed to load groups:', groupErr)
            // Don't show error if we can't load groups - just show empty state
            children = []
          }
        } else {
          error = `Page not found: ${slug}`
        }
      } else if (err.status === 403) {
        error = 'You do not have permission to view this page'
      } else if (err.message === 'Failed to fetch' || err.code === 'ECONNREFUSED') {
        // Server is down, but we can still work with cached/static data
        console.log('Server unavailable, using cached/static data only')
        error = null
      } else {
        error = err.message || 'Failed to load page'
      }
      if (slug !== '/') {
        entity = null
        children = []
      }
    } finally {
      loading = false
    }
  }

  async function handleCreatePost(event: CustomEvent) {
    const { title, content } = event.detail
    if (!$auth || !entity || !title.trim()) return

    try {
      await api.createPost({
        title: title.trim(),
        content: content.trim(),
        parentId: entity.id,
        sponsorId: $auth.id,
        auth: $auth.id
      })
      
      showNewPost = false
      await loadEntity() // Reload children
    } catch (error) {
      console.error('Failed to create post:', error)
    }
  }

  function getEntityTypeLabel(type: string): string {
    return type.charAt(0).toUpperCase() + type.slice(1)
  }

</script>


{#if loading}
  <div class="text-xs text-white/60">Loading...</div>
{:else if error}
  <div class="space-y-4">
    <div class="text-sm text-red-400">{error}</div>
    <a href={createHref('/')} class="text-xs text-white/60 hover:text-white underline">← Back to home</a>
  </div>
{:else if !entity && slug === '/'}
  <!-- No root entity, show all top-level groups as fallback -->
  <div>
    <h1 class="text-xs uppercase tracking-wider mb-8">Groups</h1>
    <div class="space-y-2">
      {#if children.length === 0}
        <p class="text-xs text-white/60">No groups found</p>
      {:else}
        {#each children as group}
          <div class="border-b border-white/10 pb-2">
            <a href={createHref(group.slug || `/${group.id}`)} class="hover:underline">
              <div class="flex items-baseline gap-2">
                <span class="text-xs text-white/60">[{group.type}]</span>
                <span class="text-sm">{group.title || group.slug || 'Untitled'}</span>
              </div>
              {#if group.content}
                <p class="text-xs text-white/60 mt-1 line-clamp-2">{group.content}</p>
              {/if}
            </a>
          </div>
        {/each}
      {/if}
    </div>
  </div>
{:else if !entity}
  <div class="space-y-4">
    <div class="text-sm text-white/60">Page not found</div>
    <a href={createHref('/')} class="text-xs text-white/60 hover:text-white underline">← Back to home</a>
  </div>
{:else}
  <div>
    <div class="mb-8">
      <h1 class="text-lg mb-2">{entity.title || entity.slug || 'Untitled'}</h1>
      {#if entity.content}
        <div class="text-sm text-white/60 prose-content">
          {@html renderMarkdown(entity.content)}
        </div>
      {/if}
    </div>

    {#if entity.type === 'group'}
      <div class="mb-6">
        {#if $auth && !showNewPost}
          <button
            on:click={() => showNewPost = true}
            class="text-xs uppercase tracking-wider border border-white/20 px-3 py-1 hover:bg-white hover:text-black transition-colors"
          >
            New Post
          </button>
        {/if}

        {#if showNewPost}
          <PostForm 
            on:submit={handleCreatePost}
            on:cancel={() => showNewPost = false}
          />
        {/if}
      </div>
    {/if}

    {#if children.length > 0}
      <div class="space-y-4">
        
        {#if entity.type === 'group'}
          {#if entity.view === 'grid'}
            <GroupViewGrid {children} />
          {:else if entity.view === 'cards'}
            <GroupViewCards {children} />
          {:else}
            <GroupViewList {children} />
          {/if}
        {:else}
          {#each children as child}
            {#if child.type === 'post'}
              <PostItem post={child} />
            {:else}
              <div class="border-b border-white/10 pb-4">
                <a href={createHref(child.slug || `/${child.id}`)} class="hover:underline">
                  <div class="flex items-baseline gap-2">
                    <span class="text-xs text-white/60">[{child.type}]</span>
                    <span class="text-sm font-medium">{child.title || child.slug || 'Untitled'}</span>
                  </div>
                </a>
                {#if child.content}
                  <p class="text-xs text-white/60 mt-1 line-clamp-2">{child.content}</p>
                {/if}
              </div>
            {/if}
          {/each}
        {/if}
      </div>
    {/if}
  </div>
{/if}
